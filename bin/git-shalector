#!/bin/bash

# Fuzzy selector for git commit hash ("sha")
# Needs to be put in your path and made executable for git to find it.
# See https://www.atlassian.com/git/articles/extending-git for more info.
# Usage:
#    git shalector

if ! git rev-parse --git-dir >/dev/null 2>&1; then
  echo 'Not in a git repository.' >&2
  exit 1
elif [ $# -gt 0 ]; then
  echo 'git-shalector does not take any arguments.' >&2
  exit 1
elif ! command -v fzf >/dev/null 2>&1; then
  echo "You must have fzf (https://github.com/junegunn/fzf) installed." >&2
  echo "If you are on Mac and use homebrew, try 'brew install fzf'" >&2
  exit 1
fi

selected_log_line=$(
  git log --color=always --format=format:'%C(bold blue)%h%C(reset) - %C(cyan)%aD%C(reset) %C(yellow)%d%C(reset) %C(normal)%s%C(reset)   %C(dim normal)[%an]%C(reset)' |
    fzf --ansi --tiebreak=index --preview-window=0
)

if [ -z "$selected_log_line" ]; then
  echo 'Cancelled.' >&2
  exit 2
fi

abbreviated_commit_hash=$(echo "$selected_log_line" | awk '{print $1}')
commit_hash=$(git rev-parse --short "$abbreviated_commit_hash")

printf "%s" "$commit_hash" | pbcopy
echo "Commit hash copied to clipboard ($commit_hash)"
